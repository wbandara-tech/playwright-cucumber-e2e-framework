name: CI - Playwright Cucumber Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Java (for Allure CLI)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install Allure CLI
        run: |
          curl -o allure-2.27.0.tgz -Ls https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.27.0/allure-commandline-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          echo "$PWD/allure-2.27.0/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Create .env file
        run: |
          cat > .env << EOF
          BASE_URL=https://automationexercise.com
          ENV=QA
          BROWSER=${{ matrix.browser }}
          HEADLESS=true
          DEFAULT_TIMEOUT=30000
          NAVIGATION_TIMEOUT=60000
          RETRY_COUNT=1
          SCREENSHOT_ON_FAILURE=true
          VIDEO_ON_FAILURE=true
          EOF

      - name: Create report directories
        run: mkdir -p reports/allure-results reports/screenshots reports/videos

      - name: Run Cucumber tests
        id: tests
        run: npm test
        continue-on-error: true

      - name: Prepare Allure environment info
        if: always()
        run: |
          echo "Browser=${{ matrix.browser }}" > reports/allure-results/environment.properties
          echo "Environment=QA" >> reports/allure-results/environment.properties
          echo "Base_URL=https://automationexercise.com" >> reports/allure-results/environment.properties
          echo "OS=ubuntu-latest" >> reports/allure-results/environment.properties
          echo "Node=$(node --version)" >> reports/allure-results/environment.properties
          echo "=== Allure results files ==="
          ls -la reports/allure-results/ || echo "Empty"
          echo "=== Result JSON count ==="
          ls reports/allure-results/*-result.json 2>/dev/null | wc -l || echo "0"

      - name: Get Allure history from gh-pages
        if: always()
        continue-on-error: true
        run: |
          git fetch origin gh-pages --depth=1 || true
          mkdir -p allure-history
          git worktree add gh-pages-branch gh-pages 2>/dev/null || true
          if [ -d gh-pages-branch/allure/history ]; then
            echo "Found previous Allure history, copying..."
            cp -r gh-pages-branch/allure/history reports/allure-results/history
          else
            echo "No previous Allure history found"
          fi

      - name: Generate Allure HTML report
        if: always()
        run: |
          allure generate reports/allure-results -o allure-report --clean
          echo "=== Allure report generated ==="
          ls -la allure-report/ | head -20

      - name: Build publish directory
        if: always()
        run: |
          mkdir -p publish-dir/allure
          cp -r allure-report/* publish-dir/allure/

          TOTAL_TESTS=0
          PASSED=0
          FAILED=0
          SKIPPED=0
          if [ -d reports/allure-results ]; then
            for f in reports/allure-results/*-result.json; do
              if [ -f "$f" ]; then
                TOTAL_TESTS=$((TOTAL_TESTS + 1))
                STATUS=$(python3 -c "import json; print(json.load(open('$f'))['status'])" 2>/dev/null || echo "unknown")
                case "$STATUS" in
                  passed) PASSED=$((PASSED + 1)) ;;
                  failed) FAILED=$((FAILED + 1)) ;;
                  skipped) SKIPPED=$((SKIPPED + 1)) ;;
                  *) SKIPPED=$((SKIPPED + 1)) ;;
                esac
              fi
            done
          fi

          BROWSER="${{ matrix.browser }}"
          BROWSER_CAP="$(echo $BROWSER | sed 's/./\U&/')"
          RUN_DATE=$(date -u +"%b %d, %Y %H:%M UTC")

          if [ "$FAILED" -eq 0 ] && [ "$TOTAL_TESTS" -gt 0 ]; then
            STATUS_COLOR="#00c853"
            STATUS_ICON="‚úÖ"
          elif [ "$FAILED" -gt 0 ]; then
            STATUS_COLOR="#ff5252"
            STATUS_ICON="‚ùå"
          else
            STATUS_COLOR="#ffc107"
            STATUS_ICON="‚ö†Ô∏è"
          fi

          if [ "$TOTAL_TESTS" -gt 0 ]; then
            P_PCT=$(( (PASSED * 100) / TOTAL_TESTS ))
            F_PCT=$(( (FAILED * 100) / TOTAL_TESTS ))
            S_PCT=$(( 100 - P_PCT - F_PCT ))
          else
            P_PCT=0; F_PCT=0; S_PCT=100
          fi

          cat > publish-dir/index.html << DASHEOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Playwright Cucumber E2E Framework</title>
            <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≠</text></svg>">
            <style>
              *{margin:0;padding:0;box-sizing:border-box}
              body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,sans-serif;background:#0a0e27;color:#e0e0e0;min-height:100vh;display:flex;flex-direction:column;align-items:center}
              .container{max-width:900px;width:100%;padding:40px 20px}
              .header{text-align:center;margin-bottom:36px}
              .logo{font-size:52px;margin-bottom:8px}
              .header h1{font-size:2.2rem;background:linear-gradient(135deg,#00bcd4,#7c4dff,#ff4081);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
              .header .subtitle{color:#80cbc4;font-size:1rem;opacity:.85}
              .status-badge{display:inline-flex;align-items:center;gap:8px;background:#141832;border:1px solid #1e2448;border-radius:24px;padding:8px 20px;margin:18px 0 24px;font-size:.85rem;color:#b0bec5}
              .status-badge .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
              .stats{display:flex;justify-content:center;gap:40px;margin-bottom:28px;flex-wrap:wrap}
              .stat{text-align:center}
              .stat .num{font-size:2.2rem;font-weight:700;background:linear-gradient(135deg,#00e5ff,#7c4dff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
              .stat .label{font-size:.78rem;color:#78909c;text-transform:uppercase;letter-spacing:1px;margin-top:2px}
              .tags{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:32px}
              .tag{padding:4px 14px;border-radius:14px;font-size:.75rem;font-weight:600;color:#fff}
              .tag.smoke{background:#00c853}.tag.auth{background:#2979ff}.tag.cart{background:#ff6d00}
              .tag.products{background:#00bfa5}.tag.regression{background:#ff4081}.tag.register{background:#3d5afe}
              .cards{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:36px}
              .card{background:#141832;border:1px solid #1e2448;border-radius:14px;padding:28px 20px;text-align:center;transition:transform .2s,border-color .2s}
              .card:hover{transform:translateY(-3px);border-color:#7c4dff}
              .card .icon{font-size:2rem;margin-bottom:12px}
              .card h3{font-size:1rem;color:#e0e0e0;margin-bottom:8px}
              .card p{font-size:.8rem;color:#78909c;line-height:1.5}
              .buttons{display:flex;justify-content:center;gap:14px;flex-wrap:wrap;margin-bottom:32px}
              .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 28px;border-radius:8px;text-decoration:none;font-size:.9rem;font-weight:600;transition:transform .2s,box-shadow .2s}
              .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
              .btn.allure{background:linear-gradient(135deg,#00c853,#00e676);color:#0a0e27}
              .btn.repo{background:linear-gradient(135deg,#ff4081,#f50057);color:#fff}
              .btn.ci{background:linear-gradient(135deg,#7c4dff,#651fff);color:#fff}
              .result-bar{display:flex;height:6px;border-radius:3px;overflow:hidden;margin:16px auto;max-width:400px;background:#1e2448}
              .result-bar .passed{background:#00c853}.result-bar .failed{background:#ff5252}.result-bar .skipped{background:#ffc107}
              .footer{text-align:center;color:#455a64;font-size:.75rem;padding:20px 0;border-top:1px solid #1e2448}
              .footer a{color:#7c4dff;text-decoration:none}
              @media(max-width:600px){.cards{grid-template-columns:1fr}.stats{gap:24px}.stat .num{font-size:1.6rem}}
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <div class="logo">üé≠</div>
                <h1>Playwright E-Commerce</h1>
                <p class="subtitle">Industrial-standard E2E test automation for AutomationExercise.com</p>
                <div class="status-badge">
                  <span class="dot" style="background:${STATUS_COLOR}"></span>
                  ${STATUS_ICON} Last run: ${RUN_DATE} ‚Ä¢ ${BROWSER_CAP} ‚Ä¢ ${TOTAL_TESTS} tests ‚Ä¢ ${PASSED} passed ‚Ä¢ ${FAILED} failed
                </div>
              </div>
              <div class="stats">
                <div class="stat"><div class="num">${TOTAL_TESTS}</div><div class="label">Test Cases</div></div>
                <div class="stat"><div class="num">5</div><div class="label">Page Objects</div></div>
                <div class="stat"><div class="num">3</div><div class="label">Browsers</div></div>
                <div class="stat"><div class="num">4</div><div class="label">Test Suites</div></div>
              </div>
              <div class="result-bar">
                <div class="passed" style="width:${P_PCT}%"></div>
                <div class="failed" style="width:${F_PCT}%"></div>
                <div class="skipped" style="width:${S_PCT}%"></div>
              </div>
              <div class="tags">
                <span class="tag smoke">@smoke</span>
                <span class="tag auth">@login</span>
                <span class="tag register">@register</span>
                <span class="tag cart">@cart</span>
                <span class="tag products">@search</span>
                <span class="tag regression">@regression</span>
              </div>
              <div class="cards">
                <div class="card"><div class="icon">üîê</div><h3>Authentication</h3><p>Register, Login, Logout &amp; duplicate email validation</p></div>
                <div class="card"><div class="icon">üõí</div><h3>Cart &amp; Checkout</h3><p>Add to cart, quantity, verify items, remove &amp; checkout flow</p></div>
                <div class="card"><div class="icon">üîç</div><h3>Products &amp; Search</h3><p>Product listing, search, categories &amp; product details</p></div>
                <div class="card"><div class="icon">‚öôÔ∏è</div><h3>CI/CD Pipeline</h3><p>GitHub Actions with cross-browser matrix, smoke tests &amp; scheduled runs</p></div>
              </div>
              <div class="buttons">
                <a href="./allure/" class="btn allure">üìä View Allure Report</a>
                <a href="https://github.com/wbandara-tech/playwright-cucumber-e2e-framework" class="btn repo" target="_blank">üíª View Repository</a>
                <a href="https://github.com/wbandara-tech/playwright-cucumber-e2e-framework/actions" class="btn ci" target="_blank">üöÄ CI Runs</a>
              </div>
              <div class="footer">
                Built with <a href="https://playwright.dev">Playwright</a> + <a href="https://cucumber.io">Cucumber</a> ‚Ä¢
                TypeScript ‚Ä¢ Page Object Model ‚Ä¢ Allure Reports<br>
                &copy; 2026 wbandara-tech
              </div>
            </div>
          </body>
          </html>
          DASHEOF

          echo "=== Publish directory structure ==="
          find publish-dir -type f | head -30

      - name: Publish to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: publish-dir

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.browser }}
          path: |
            reports/
          retention-days: 30
